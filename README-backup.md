# Opex autochad Postgresql RDS

A Terraform module to deploy the trading distribution Competition Postgres Database to AWS.

The DB is multi AZ enabled so will failover between AZ's in case of failure.

We currently define the following variables to provide back up functionality.
This provides one back up every 24 hours between the hours of 5:00 and 6:00 am:

```
backup_window = "04:00-05:00"
maintenance_window = "Tue:05:00-Tue:06:00"
backup_retention_period = 7
```

To deploy directly from localhost:

```
REGION=`eu-west-1` ENV=`<ENV>` VERSION=`<VERSION>` aws-okta exec <ENV> -- make init
REGION=`eu-west-1` ENV=`<ENV>` VERSION=`<VERSION>` aws-okta exec <ENV> -- make plan
REGION=`eu-west-1` ENV=`<ENV>` VERSION=`<VERSION>` aws-okta exec <ENV> -- make apply
```

To login to the Postgres instance on dev use:

```
psql -h opex-autochad-db.trading.aws-eu-west-1.dev.williamhill.plc -d autochaddb -U dbadmin
```


## Terraform - What's it all about (0.11.14)

Terraform allows us to deploy infrastructure to AWS by defining `.tf` scripts and executing terraform commands.

The official documentation is very good:

- [Terraform Documentation](https://www.terraform.io/docs/index.html)
- [Terraform RDS Documentation](https://www.terraform.io/docs/providers/aws/r/db_instance.html)

There are many elements of the Terraform code given here that are re-useable when writing modules for other types of infrastructure(MSK,EC2.. etc)

### Params Folder / variables.tf:

Provides a place to supply environment specific overrides to the default values held in `variables.tf` file.

### username.tf and password.tf

These files are used to create/provide a password and username for your infrastructure.

They are both then stored in the [AWS Parameter Store](https://eu-west-1.console.aws.amazon.com/systems-manager/parameters?region=eu-west-1), using the name provided.

In the case of the username this is `/opex/autochad/rds/admin_username`

The password is also stored in the parameter store, the difference being that the password is randomly generated and encrypted.

### backend.tf and remote-state.tf

`backend.tf` states the existence of an S3 backend.

This is used to store the TF remote state which is accessed in `remote-state.tf`

There are currently 2 concepts of remote state at WH - One is managed by the AWS - COE Team and the other by trading.

These remote state buckets contain state that is common to all AWS deployments including common network blocks and IP ranges.


### tags.tf

The `tags.tf` file contains all of the Standard tags that are to be used across the WH estate.

For more information on the tags that are required

- [WH Tagging Standards](https://conf.willhillatlas.com/display/whc/AWS+Foundations+-+Naming+and+Tagging+Standards)

There are also some tags that have been recommended as additions to the standards for trading:

- [Trading Tagging Standards](https://conf.willhillatlas.com/pages/viewpage.action?pageId=250740373)

The trading standards are not enforced and are only a recommendation, the list of takes is non-exhaustive and it is encouraged that you update the standards if you have a justified requirement for a new tag/value.

### r53.tf

Allows us to define a fixed prefix for the service url that is defined in Route 53 as a CNAME. This gives us a consistent user-friendly name to contact the app on.


### common.tf and provider.tf

Both of these files are included with every TF deployment at WH. provider.tf define AWS as the cloud provider and common.tf defines VPC network blocks.

### output.tf
Defines any outputs expected to be generated by running the code. In this case it is just the URL of the service.

### rds-master.tf

Defines the config of the RDS instance and any security groups that it is required to be a member of.

- [Terraform RDS Documentation](https://www.terraform.io/docs/providers/aws/r/db_instance.html)

